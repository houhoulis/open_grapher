<!DOCTYPE html>
<html>
<meta charset="utf-8">
<body>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<div id="container" style="height: 800px"></div>
<p>click<br />here</p>

<script>

  var query = window.location.search.slice(1).split('&');

  var parts = ["title", "subtitle", "start", "x", "y"];

  parseItem = function(chunk) {
    parted = chunk.split('=');
    return { label: parted[0], value: parted[1] };
  };

  findItem = function(label) {
    var item = query.find(function(entry) {
      return parseItem(entry).label === label;
    });

    return parseItem(item).value;
  };

  dataItems = function() {
    var data = query.filter(function(entry) {
      return !parts.some(function(part) {
        return part === parseItem(entry).label;
      });
    });

    return data.map(function(item) {
      return parseItem(item);
    });
  };

  chartableItem = function(itemObj) {
    var valueData = itemObj.value;
    var values = valueData.split(',').map(function(datum) {
      if(datum === "") {
        return null;
      } else {
        return parseFloat(datum);
      }
    });
    return {
      name: decodeURIComponent(itemObj.label),
      data: values
    };
  };

  seriesItems = function() {
    var items = dataItems();

    // hack to shove in theil-sen attempt
    let results = items.map(function(item) {
      return chartableItem(item);
    });
    let theil_sen_thing = {
      name: results[0].name + 'theil',
      data: theilSen(results[0].data)
    }
    results.push(theil_sen_thing);
    console.table(theil_sen_thing);
    return results
  };

  startPoint = function() {
    var start = parseFloat(findItem("start"));

    if(isNaN(start)) {
      start = 15;
    };

    return start;
  };

  var chart = Highcharts.chart('container', {

    title: {
      text: decodeURIComponent(findItem('title'))
    },

    subtitle: {
      text: decodeURIComponent(findItem('subtitle'))
    },

    xAxis: {
      title: {
        text: decodeURIComponent(findItem('x'))
      }
    },
    yAxis: {
      title: {
        text: decodeURIComponent(findItem('y'))
      }
    },
    legend: {
      layout: 'horizontal',
      align: 'center',
      verticalAlign: 'top',
      y: 50
    },

    plotOptions: {
      series: {
        pointStart: startPoint(),
        connectNulls: true
      }
    },

    series: seriesItems()
  });


  function theilSen(series) {
    console.warn("theilsen accepted series:")
    console.warn(series);
    let slopes = [];
    const ersatzPoints = series.map((value, index) => [index, value]);
    console.warn("series => ersatxzPonts:")
    console.warn(ersatzPoints);
    ersatzPoints.filter(arr => arr[1] !== null).forEach(function(point) {
      const others = ersatzPoints.filter(a_point => a_point[0] !== point[0]);
      others.forEach(function(other) {
        slopes.push([
          point,
          other,
          (point[1] - other[1]) / (point[0] - other[0])
        ]);
      });
    });
    let slosum = slopes.reduce(((accum, elt) => accum + elt[2]), 0);
    console.warn("slosum: " + typeof(slosum));
    console.warn(slosum);
    console.table(slopes);
    const slope_fit = median(slopes.map(arr => arr[2]));
    console.info("slope_fit: " + slope_fit);
    y_intercept = median(ersatzPoints.filter(arr => arr[1] !== null).map(point => point[1] - slope_fit * point[0]));
    console.warn("y_intercept: " + y_intercept);
    return ersatzPoints.map(point => slope_fit * point[0] + y_intercept);
  };


function median(values) {
  // console.error('median:'); console.table(values);
  const length = values.length;
  values = values.sort((a, b) => a > b);
  // console.table(values);
  if(length % 2 == 0) {
    return (values[(length / 2) - 1] + values[length / 2]) / 2;
  } else {
    return values[length / 2 - 0.5];
  }
}


document.querySelector('p').addEventListener('click', function() {
  window.location.assign(window.location.href + "&thingee=-1,-2,-3,-4,-5,-6,-7,-8,-9,-10")
});

</script>

</body>
</html>

